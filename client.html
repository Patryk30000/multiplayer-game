<!DOCTYPE html>
<html>
<head>
    <title>Multiplayer Game</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial; display: flex; }
        canvas { border:1px solid black; }
        #chat { width: 300px; margin-left: 10px; }
        #messages { height: 500px; border: 1px solid #ccc; overflow-y: auto; padding: 5px; }
    </style>
</head>

<body>

<canvas id="game" width="800" height="600"></canvas>

<div id="chat">
    <div id="messages"></div>
    <input id="name" placeholder="Name" />
    <input id="input" placeholder="Type message..." />
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const socket = io();

let myId = null;
let players = {};

// ---- Physics (unchanged) ----
const GRAVITY = 0.6;
const MOVE_SPEED = 4;
const JUMP_FORCE = -12;
const PLAYER_RADIUS = 10;
const GROUND_Y = 580;

let velocities = {};

// ---- Input ----
let keys = {};
let jumpPressed = false;

// ---- Socket ----
socket.on("init", data => {
    myId = data.id;
    players = data.players;
    for (let id in players) {
        velocities[id] = { vx:0, vy:0, onGround:false };
    }
});

socket.on("update", data => {
    players = data;
    for (let id in players) {
        if (!velocities[id]) {
            velocities[id] = { vx:0, vy:0, onGround:false };
        }
    }
});

socket.on("chat", data => addMessage(`<b>${data.name}:</b> ${data.message}`));
socket.on("system", msg => addMessage(`<i>${msg}</i>`));

// ---- Key handling (FIXED) ----
document.addEventListener("keydown", e => {
    if (!keys[e.key] && e.key === "ArrowUp") {
        jumpPressed = true;   // edge-triggered jump
    }
    keys[e.key] = true;
});

document.addEventListener("keyup", e => {
    keys[e.key] = false;
});

// ---- Game loop ----
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function update() {
    if (!myId || !players[myId]) return;

    let p = players[myId];
    let v = velocities[myId];

    // Horizontal movement
    if (keys["ArrowLeft"]) v.vx = -MOVE_SPEED;
    else if (keys["ArrowRight"]) v.vx = MOVE_SPEED;
    else v.vx = 0;

    // Jump (FIXED)
    if (jumpPressed && v.onGround) {
        v.vy = JUMP_FORCE;
        v.onGround = false;
    }

    // Gravity
    v.vy += GRAVITY;

    // Apply movement
    p.x += v.vx;
    p.y += v.vy;

    // Ground collision
    if (p.y + PLAYER_RADIUS >= GROUND_Y) {
        p.y = GROUND_Y - PLAYER_RADIUS;
        v.vy = 0;
        v.onGround = true;
    }

    // Reset jump press after processing
    jumpPressed = false;

    // Send movement (unchanged)
    socket.emit("move", {
        id: myId,
        dx: v.vx,
        dy: v.vy
    });
}

function draw() {
    // Gray background
    ctx.fillStyle = "#808080";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Ground
    ctx.fillStyle = "#333";
    ctx.fillRect(0, GROUND_Y, 800, 20);

    // Players
    for (let id in players) {
        ctx.beginPath();
        ctx.arc(players[id].x, players[id].y, PLAYER_RADIUS, 0, Math.PI * 2);
        ctx.fillStyle = id === myId ? "red" : "blue";
        ctx.fill();
    }
}

// ---- Chat ----
document.getElementById("input").addEventListener("keydown", e => {
    if (e.key === "Enter") {
        const name = document.getElementById("name").value || "Player";
        const msg = e.target.value;
        if (msg.trim()) {
            socket.emit("chat", { name, message: msg });
            e.target.value = "";
        }
    }
});

function addMessage(html) {
    const div = document.createElement("div");
    div.innerHTML = html;
    const messages = document.getElementById("messages");
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

// Start
loop();
</script>

</body>
</html>
